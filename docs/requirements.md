# LVFontConv - PyQt6 字体转换工具需求文档

## 项目概述

LVFontConv 是一个基于 PyQt6 的图形化字体转换工具，用于将 TTF/WOFF/OTF 字体文件转换为 LVGL (Light and Versatile Graphics Library) 支持的 bitmap 字体格式。该工具提供直观的用户界面，并支持转换前预览字体效果。

## 参考项目

- **lv_font_conv**: Node.js 命令行工具，用于将字体转换为 LVGL 格式
- GitHub: https://github.com/lvgl/lv_font_conv

## 核心功能需求

### 1. 字体文件加载与解析

#### 1.1 支持的字体格式
- TTF (TrueType Font)
- WOFF (Web Open Font Format)
- WOFF2 (Web Open Font Format 2)
- OTF (OpenType Font)

#### 1.2 字体文件选择
- 支持通过文件对话框选择单个或多个字体文件
- 显示已加载字体文件列表
- 支持拖拽字体文件到应用窗口
- 支持字体合并（从多个字体源提取不同字符）

#### 1.3 字体信息显示
- 字体名称
- 字体家族
- 字体样式（Regular, Bold, Italic 等）
- 字符数量
- 支持的字符范围

### 2. 字符范围选择

#### 2.1 字符选择方式
- **Unicode 范围选择**: 
  - 支持十进制和十六进制输入
  - 单个字符：如 `0x1F450` 或 `128080`
  - 字符范围：如 `0x20-0x7F`
  - 字符映射：如 `0x1F450=>0xF005`
  - 范围映射：如 `0x1F450-0x1F470=>0xF005`
  
- **符号列表输入**:
  - 直接输入需要的字符：如 `0123456789.,`
  - 支持 Unicode 字符直接粘贴
  
- **预设范围**:
  - ASCII 基础字符 (0x20-0x7F)
  - 常用数字和标点
  - 拉丁扩展字符
  - 中文常用字符（GB2312 一级/二级）
  - 自定义预设管理

#### 2.2 多字体字符分配
- 为每个加载的字体分配不同的字符范围
- 可视化显示字符范围分配情况
- 字符范围冲突检测和提示

### 3. 转换参数配置

#### 3.1 基础参数
- **字体大小 (size)**: 输出字体大小（像素），范围 8-200
- **位深度 (bpp - Bits Per Pixel)**: 
  - 1 bit: 单色/二值图像
  - 2 bit: 4 级灰度
  - 3 bit: 8 级灰度
  - 4 bit: 16 级灰度
- **输出格式**:
  - LVGL C 源文件格式（.c）
  - Binary 二进制格式（.bin）
  - Dump 调试格式（用于开发调试）

#### 3.2 高级参数
- **压缩选项**:
  - 启用/禁用内置 RLE 压缩
  - 启用/禁用位图预过滤（XOR）
  
- **字距调整 (Kerning)**:
  - 保留/删除字距信息
  - 强制使用快速字距格式
  
- **渲染选项**:
  - LCD 子像素渲染（水平 3x 分辨率）
  - LCD-V 子像素渲染（垂直 3x 分辨率）
  - 使用字形颜色信息创建灰度图标
  
- **字节对齐**:
  - 位图行尾字节对齐选项
  
- **Autohinting**:
  - 关闭自动微调
  - 使用强力自动微调

#### 3.3 LVGL 特定选项
- 自定义 `lvgl.h` 包含路径
- 字体命名规则设置

### 4. 字体预览功能 ⭐

#### 4.1 实时预览窗口
- **预览区域**:
  - 显示选定字符在当前配置下的渲染效果
  - 支持缩放查看（25%, 50%, 100%, 200%, 400%）
  - 支持平移浏览大尺寸预览
  
- **预览内容选择**:
  - 单个字符预览
  - 字符序列预览（可输入测试文本）
  - 字符集网格预览（显示所有选中字符）

#### 4.2 网格背景选项
- **背景样式**:
  - 纯色背景（可自定义颜色）
  - 棋盘网格（可调整网格大小：4x4, 8x8, 16x16）
  - 点状网格
  - 可自定义网格颜色和透明度
  
- **背景颜色**:
  - 白色
  - 黑色
  - 灰色
  - 自定义 RGB 颜色

#### 4.3 Color Depth 预览支持
- **1-bit (单色) 预览**:
  - 纯黑白显示
  - 阈值可调整（50%默认）
  
- **2-4 bit (灰度) 预览**:
  - 按实际灰度级别显示
  - 显示灰度级别数（4级/8级/16级）
  
- **16-bit 预览** (RGB565):
  - 模拟 16-bit 颜色深度显示
  - 显示颜色量化效果
  
- **32-bit 预览** (RGB888):
  - 全彩色显示
  - 显示 Alpha 通道效果

#### 4.4 预览信息显示
- 当前字符的 Unicode 编码
- 字形尺寸（宽度 x 高度）
- 字形偏移量（X/Y offset）
- 前进宽度（Advance Width）
- 字距调整值（如果适用）
- 内存占用估算

### 5. 转换与导出

#### 5.1 转换过程
- 显示转换进度条
- 显示当前处理的字符
- 支持取消转换
- 转换完成后显示统计信息：
  - 转换字符数
  - 输出文件大小
  - 压缩率（如果启用压缩）
  - 转换耗时

#### 5.2 输出文件
- 选择输出目录和文件名
- 支持输出文件预览（查看生成的 C 代码）
- 自动生成配套的头文件（.h）
- 可选生成字体信息文档（JSON 格式）

#### 5.3 批量转换
- 支持保存转换配置为配置文件
- 支持加载配置文件批量转换
- 命令行模式支持（可选）

### 6. 用户界面设计

#### 6.1 主窗口布局
```
┌─────────────────────────────────────────────────────────┐
│  菜单栏: 文件 | 编辑 | 视图 | 工具 | 帮助                │
├─────────────────────────────────────────────────────────┤
│  工具栏: [打开] [保存] [转换] [预览] [设置]            │
├──────────────┬──────────────────────────────────────────┤
│              │                                          │
│  字体列表    │         预览区域                         │
│  ┌────────┐  │  ┌────────────────────────────────────┐ │
│  │Font 1  │  │  │                                    │ │
│  │Font 2  │  │  │      字体预览显示区域              │ │
│  └────────┘  │  │                                    │ │
│              │  └────────────────────────────────────┘ │
│  字符范围    │                                          │
│  [添加范围]  │  预览控制                                │
│              │  [网格背景] [Color Depth: 32/16/1]      │
├──────────────┴──────────────────────────────────────────┤
│  转换参数配置区                                          │
│  大小: [16] BPP: [4▼] 格式: [LVGL▼]                    │
│  □ 压缩  □ 字距  □ LCD渲染                              │
├─────────────────────────────────────────────────────────┤
│  状态栏: 就绪 | 字符数: 0 | 大小: 0 KB                  │
└─────────────────────────────────────────────────────────┘
```

#### 6.2 对话框
- 字体文件选择对话框
- 字符范围编辑器对话框
- 高级设置对话框
- 关于对话框

#### 6.3 主题支持
- 支持亮色/暗色主题切换
- 跟随系统主题（可选）

### 7. 配置管理

#### 7.1 项目配置
- 保存/加载转换项目配置（.lvfont 格式）
- 配置包含：
  - 字体文件路径
  - 字符范围设置
  - 转换参数
  - 输出路径
  
#### 7.2 应用设置
- 上次使用的目录记忆
- UI 布局保存
- 默认参数设置
- 最近打开的项目列表

### 8. 错误处理与验证

#### 8.1 输入验证
- 字体文件格式验证
- Unicode 范围有效性检查
- 参数范围检查
- 字符存在性验证

#### 8.2 错误提示
- 友好的错误消息
- 错误详情日志
- 解决方案建议

#### 8.3 警告提示
- 字符范围冲突警告
- 大文件输出警告
- 字距信息丢失警告

## 技术实现要求

### 9.1 开发环境
- **Python 版本**: Python 3.9+
- **UI 框架**: PyQt6
- **字体处理库**: 
  - fontTools (OpenType/TTF 解析)
  - Pillow (图像渲染)
  - freetype-py (FreeType 绑定)

### 9.2 依赖库
```python
PyQt6>=6.4.0
fontTools>=4.38.0
Pillow>=9.3.0
freetype-py>=2.3.0
numpy>=1.24.0
```

### 9.3 项目结构
```
LVFontConv/
├── docs/                      # 文档目录
│   ├── requirements.md        # 需求文档
│   └── tasks.md               # 任务分解
├── src/                       # 源代码目录
│   ├── __init__.py
│   ├── main.py                # 主程序入口
│   ├── ui/                    # UI 模块
│   │   ├── __init__.py
│   │   ├── main_window.py     # 主窗口
│   │   ├── preview_widget.py  # 预览控件
│   │   └── dialogs.py         # 对话框
│   ├── core/                  # 核心功能模块
│   │   ├── __init__.py
│   │   ├── font_loader.py     # 字体加载
│   │   ├── font_converter.py  # 字体转换
│   │   ├── glyph_renderer.py  # 字形渲染
│   │   └── range_parser.py    # 范围解析
│   ├── writers/               # 输出格式写入器
│   │   ├── __init__.py
│   │   ├── lvgl_writer.py     # LVGL 格式
│   │   ├── bin_writer.py      # 二进制格式
│   │   └── dump_writer.py     # 调试格式
│   └── utils/                 # 工具模块
│       ├── __init__.py
│       ├── config.py          # 配置管理
│       └── logger.py          # 日志管理
├── resources/                 # 资源文件
│   ├── icons/                 # 图标
│   └── styles/                # 样式表
├── tests/                     # 测试代码
│   └── __init__.py
├── requirements.txt           # Python 依赖
├── setup.py                   # 安装脚本
└── README.md                  # 项目说明
```

### 9.4 代码规范
- 遵循 PEP 8 代码风格
- 使用类型注解（Type Hints）
- 完善的文档字符串（Docstrings）
- 单元测试覆盖率 > 80%

## 性能要求

### 10.1 响应性能
- UI 操作响应时间 < 100ms
- 字体预览刷新 < 200ms
- 字体加载时间 < 2s（普通字体）

### 10.2 资源占用
- 内存占用 < 500MB（单个字体）
- 支持的最大字符数: 65536

### 10.3 兼容性
- 操作系统: Windows 10+, macOS 10.14+, Linux (Ubuntu 20.04+)
- 屏幕分辨率: 1280x720 最小分辨率
- HiDPI/Retina 显示支持

## 可选的未来扩展功能

### 11.1 高级功能
- 字形编辑器（微调单个字形）
- 批量字体处理
- 字体对比工具
- 性能分析工具

### 11.2 集成功能
- 与 LVGL 项目直接集成
- Git 版本控制集成
- CI/CD 支持

### 11.3 协作功能
- 云端配置同步
- 团队字体库共享

## 文档要求

### 12.1 用户文档
- 安装指南
- 使用教程（带截图）
- 常见问题解答（FAQ）
- 参数详解

### 12.2 开发文档
- API 文档
- 架构设计文档
- 开发指南
- 贡献指南

## 测试要求

### 13.1 单元测试
- 核心功能模块测试
- 边界条件测试
- 异常处理测试

### 13.2 集成测试
- UI 功能测试
- 端到端转换流程测试
- 多平台兼容性测试

### 13.3 性能测试
- 大字符集转换测试
- 内存泄漏测试
- 并发操作测试

## 交付标准

### 14.1 软件交付
- 可执行程序（Windows .exe, macOS .app, Linux AppImage）
- 源代码（GitHub 仓库）
- 依赖库清单

### 14.2 文档交付
- 完整的用户手册
- API 文档
- 示例项目

### 14.3 质量标准
- 无严重 Bug
- 核心功能测试通过率 100%
- 代码审查通过
- 文档完整准确

## 版本规划

### Phase 1: MVP（最小可行产品）
- 基础字体加载和解析
- Unicode 范围选择
- 基础转换参数配置
- LVGL 格式输出
- 简单的字体预览

### Phase 2: 完整预览功能
- 网格背景支持
- 多种 Color Depth 预览
- 预览信息详情
- 预览缩放和导航

### Phase 3: 增强功能
- 多字体合并
- 高级转换参数
- 配置管理
- 批量转换

### Phase 4: 优化与扩展
- 性能优化
- UI/UX 改进
- 跨平台打包
- 插件系统（可选）

---

**文档版本**: 1.0  
**创建日期**: 2025-11-07  
**最后更新**: 2025-11-07  
**负责人**: Development Team
